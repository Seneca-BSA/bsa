<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Lab 6 : Timer Interrupt and C Code - Lab Manuals</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lab 6 : Timer Interrupt and C Code";
        var mkdocs_page_input_path = "seh500\\lab6.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> Lab Manuals
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../aig240/">AIG240 Robotics</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../ses250/">SES250 Electromagnatics</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../">SEH500 Microprocessors</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../sep600/">SEP600 Embedded Systems</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../sea700/">SEA700 Robotics for Engineer</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">Lab Manuals</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Lab 6 : Timer Interrupt and C Code</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lab-6-timer-interrupt-and-c-code">Lab 6 : Timer Interrupt and C Code</h1>
<p><font size="5">
Seneca Polytechnic</br>
SEH500 Microprocessors and Computer Architecture
</font></p>
<h2 id="introduction">Introduction</h2>
<p>Documentation of the Cortex-M4 instruction set can be found here:</p>
<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001">Arm Cortex-M4 Processor Technical Reference Manual Revision</a> (<a href="../Cortex-M4-Proc-Tech-Ref-Manual.pdf">PDF</a>)<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001/Programmers-Model/Instruction-set-summary/Table-of-processor-instructions">Table of processor instructions</a></li>
</ul>
</li>
<li><a href="https://developer.arm.com/documentation/ddi0403/latest/">ARMv7-M Architecture Reference Manual</a> (<a href="../DDI0403E_e_armv7m_arm.pdf">PDF</a>)</li>
</ul>
<p>In our labs so far, we've been programming the processor directly using assembly language. In this lab, we'll explore combining assembly language with C programming language and how to use them interchangeablely in a program.</p>
<h2 id="procedures">Procedures</h2>
<ol>
<li>
<p>Open MCUXpresso then start a new C/C++ project based on the Freedom board model that you have.</p>
</li>
<li>
<p>In the new project configuration, this time, also select "pit" as one of the driver. Rename the project then leave all other settings as default.</p>
<p><img alt="Figure 6.1 Select pit in the project setting" src="../lab6-pit.png" /></p>
<p><em><strong>Figure 6.1</strong> Select pit in the project setting</em></p>
</li>
<li>
<p>In previous labs, we wrote all of our code in assembly language using the <code>.s</code> file extension. In this lab, we are going to explore how to integrate C-code together with assembly code in a single project. The first way of integrating assembly code into a C-program is by using the inline assembler method.</p>
<pre><code>__asm volatile (" &lt;Assembly Code Here&gt; ");
</code></pre>
<p>Replace (or comment out) the PRINTF "Hello World" line from the starting example code then add the following:</p>
<pre><code>__asm volatile (" mov r0, #1 ");
</code></pre>
</li>
<li>
<p>Next, build and create the dissambly code (or inspect from the dissambly view window during debug).</p>
<p><strong>Question 1:</strong> Find the inline assembly code <code>mov r0, #1</code> from Step 4 from the disassembly view. Take a screenshot of it and confirm that the C-code and the assembly code are the same.</p>
</li>
<li>
<p>You can also write multi-line inline assembly code as below. As the <code>__asm</code> function is a direct replicate of what you wrote into assembly, you'll need to use newline character to specify a newline in assembly. You can also align your C-code to make it more readable.</p>
<pre><code>__asm volatile (" mov r0, #1 \n"
                " mov r3, #0x75 ");
</code></pre>
</li>
<li>
<p>Continue adding to the inline assembly code with the following code from <a href="../lab5/">Lab 5</a> Example Code 5.2.</p>
<pre><code>    mov     r0, #1
    mov     r3, #0x75
    push    {r0, r3}
    mov     r0, #6
    mov     r3, #7
    pop     {r0, r3}
</code></pre>
</li>
<li>
<p>Another method to include assembly code is by adding a <code>.s</code> file into the project. Create a <code>function.s</code> file in the source folder and paste the following extract from Lab 5 into it.</p>
<pre><code>.syntax unified             @ unified syntax used
.cpu cortex-m4              @ cpu is cortex-m4
.thumb                      @ use thumb encoding

.text                       @ put code in the code section

.global function1           @ declare as a global variable
.type function1, %function  @ set to function type

function1:
    push    {r5, lr}        @ Save values in the stack
    mov     r5, #8          @ Set initial value for the delay loop
delay:
    subs    r5, r5, #1      
    bne     delay
    pop     {r5, pc}        @ pop out the saved value from the stack
</code></pre>
</li>
<li>
<p>Next, place a function prototype at the top of your code in your <code>.c</code> file and a function call after your inline assembly code you wrote easier but before the while loop into your main function.</p>
<p>Add this on top:</p>
<pre><code>void function1();
</code></pre>
<p>And this after your inline assembly code:</p>
<pre><code>function1();
</code></pre>
</li>
<li>
<p>Set a breakpoint at the <code>__asm</code> function then debug your code. Once the program start, hit resume until it reach the breakpoint then "Step Into (F5)" the code and see what happens. You debugger should jump from the <code>.c</code> file to the code in your assembly file when it hit the function call.</p>
</li>
<li>
<p>Your task now is to translate the assembly code in the loop portion of <a href="../lab5/">Lab 5</a> (see below) into C-code. Read and understand the assembly code so the intention will be the same once translated into C. Do not use any inline assembly code except for moving data directly into register, ie <code>mov r5, #9</code>. Use variables and function call to perform all other operation.</p>
<p>Translate the following:</p>
<pre><code>loop:
    add     r0, r0, #1
    cmp     r0, #5
    bne     loop
    mov     r5, #9
    bl      function1
    mov     r3, #12
</code></pre>
<p>You can use a <code>for</code> loop or a <code>while</code> loop along with an integer as the counter. After you are done and get the same desired result as you got from <a href="../lab5/">Lab 5</a>, find compiled assembly code from the C-code you wrote.</p>
<p><strong>Question 2:</strong> Compare and comment on the difference between the compiled assembly code and the assembly code given in terms of the type and number of instructions used.</p>
<p><strong>Question 3:</strong> Take a screenshot of your <code>while</code> or <code>for</code> loop C-code and its assembly code and paste them into Blackboard.</p>
</li>
<li>
<p>Lastly, we are going to familarize ourself with the idea of interrupt by including a periodic interrupt timer (PIT) into our code to generate an interrupt once every second. Instead of programming the interrupt from scratch, we'll use the built-in ConfigTools in MCUXpresso for ease of implementation. The ConfigTools allow us to setup components of the processor and the microcontroller board in a quick and fast manner instead of manually coding all the necessary settings. Go to "ConfigTools &gt; Peripherals" from the top menu. In the "Components" tab, Under "Peripheral drivers (Device specific)" add the "PIT" configuration components.</p>
</li>
<li>
<p>Under the PIT settings, <strong>uncheck</strong> "start channel". Leave everything default so the setting page should look like this:</p>
<p><img alt="Figure 6.2 PIT settings" src="../lab6-pit-settings.png" /></p>
<p><em><strong>Figure 6.2</strong> PIT settings</em></p>
</li>
<li>
<p>Once confirmed, click "Update Code" at the top menu button bar and click yes when prompted. The <code>peripherals.c</code> and <code>peripherals.h</code> will now be updated accordingly to include the timer interrupt settings.</p>
</li>
<li>
<p>Next, we'll need to add some code for the interrupt handler and to start the interrupt.</p>
<p>Paste the following handler code into your program on top of main.</p>
<pre><code>void PIT_CHANNEL_0_IRQHANDLER(void) /*ISR to process PIT channel 0 interrupts*/
{
    PIT_ClearStatusFlags(PIT, PIT_CHANNEL_0, kPIT_TimerFlag);
    //clear PIT channel 0 interrupt status flag
    PRINTF("*\r\n");
}
</code></pre>
<p>Then use the following code to start the PIT in your main function. You can put it at the beginning of main after all the initialization or just before the empty while loop.</p>
<pre><code>PIT_StartTimer(PIT_PERIPHERAL, PIT_CHANNEL_0);
</code></pre>
</li>
<li>
<p>Build and debug. Open a serial monitor to see the serial output. Let the program run and you should see an "*" being printed every second. Verify with a watch that the output is once per second.</p>
<p><strong>Question 4:</strong> Take a screenshot of your serial monitor output and paste it into Blackboard.</p>
</li>
</ol>
<h2 id="lab-questions">Lab Questions</h2>
<div style="padding: 15px; border: 1px solid orange; background-color: orange; color: black;">
<b>GenAI Usage Policy:</b>
<p>Submission of answers or code generated by AI, or from external help, containing concepts or instructions not shown/taught/discussed in this course will immediately result in a report of Academic Integrity violation.</p>
<p>If GenAI was used as a learning aid, you must cite it for every answer that used GenAI as a tool, as follows:<p>
<ul><li>GenAI used: Copilot for concept research; ChatGPT for editing and grammar enhancement; Gemini for code generation in section 1, as identified.</li></ul>
</div>

<p>Using the skills and knowledge acquired from this lab, answer the following post-lab question(s) on Blackboard. Due one week after the lab.</p>
<ol>
<li>
<p>Find the inline assembly code <code>mov r0, #1</code> from Step 4 from the disassembly view. Take a screenshot of it and confirm that the C-code and the assembly code are the same. Copy and paste your code with your answers, along with the necessary screenshots, into Blackboard. <strong>No mark will be awarded if no screenshot with the expected result is provided.</strong></p>
</li>
<li>
<p>Compare and comment on the difference between the compiled assembly code and the assembly code given in Step 10 in terms of the type and number of instructions used.</p>
</li>
<li>
<p>Take a screenshot of your <code>while</code> or <code>for</code> loop C-code and its assembly code and paste them into Blackboard. <strong>No mark will be awarded if no screenshot with the expected result is provided.</strong></p>
</li>
<li>
<p>Take a screenshot of your serial monitor output from Step 15 and paste it into Blackboard. <strong>No mark will be awarded if no screenshot with the expected result is provided.</strong></p>
</li>
<li>
<p>Modify your code from Step 15 so instead of printing "*" every second (from your timer interrupt function), print a statement that displays the number of minute(s) and second(s) since the timer started, along with your name. You can be creative.</p>
<pre><code>...
(Someone) started the timer 0 min 59 sec ago
(Someone) started the timer 1 min 0 sec ago
(Someone) started the timer 1 min 1 sec ago
...
</code></pre>
<p>Paste your code and a screenshot of the output into Blackboard. <strong>No mark will be awarded if no screenshot with the expected result is provided.</strong></p>
</li>
</ol>
<h2 id="reference">Reference</h2>
<p>[1] Yiu, J. (2013). The Definitive Guide to ARM® Cortex®-M3 and Cortex®-M4 Processors. (3rd ed.). Elsevier Science &amp; Technology.</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
