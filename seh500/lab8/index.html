<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Lab 8 : GPIO Input and Code Optimization - BSA Lab Manuals</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lab 8 : GPIO Input and Code Optimization";
        var mkdocs_page_input_path = "seh500/lab8.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> BSA Lab Manuals
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Lab Manuals</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../ses250/">SES250 Electromagnatics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../">SEH500 Microprocessors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sep600/">SEP600 Embedded Systems</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sea700/">SEA700 Robotics</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">BSA Lab Manuals</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Lab 8 : GPIO Input and Code Optimization</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lab-8-gpio-input-and-code-optimization">Lab 8 : GPIO Input and Code Optimization</h1>
<p><font size="5">
Seneca Polytechnic</br>
SEH500 Microprocessors and Computer Architecture
</font></p>
<h2 id="introduction">Introduction</h2>
<p>Documentation of the Cortex-M4 instruction set can be found here:</p>
<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001">Arm Cortex-M4 Processor Technical Reference Manual Revision</a> (<a href="../Cortex-M4-Proc-Tech-Ref-Manual.pdf">PDF</a>)<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001/Programmers-Model/Instruction-set-summary/Table-of-processor-instructions">Table of processor instructions</a></li>
</ul>
</li>
<li><a href="https://developer.arm.com/documentation/ddi0403/latest/">ARMv7-M Architecture Reference Manual</a> (<a href="../DDI0403E_e_armv7m_arm.pdf">PDF</a>)</li>
</ul>
<p>Documentation of the Freedom K64 and K66 board and it's microcontroller can be found here:</p>
<ul>
<li><a href="https://www.nxp.com/webapp/Download?colCode=FRDMK64FUG">FRDM-K64F Freedom Module User’s Guide</a> (<a href="../FRDMK64FUG.pdf">PDF</a>)</li>
<li><a href="https://www.nxp.com/webapp/Download?colCode=K64P144M120SF5RM">Kinetis K64 Reference Manual</a> (<a href="../K64P144M120SF5RM.pdf">PDF</a>)</li>
<li><a href="https://www.nxp.com/webapp/Download?colCode=FRDMK66FUG">FRDM-K66F Freedom Module User’s Guide</a> (<a href="../FRDMK66FUG.pdf">PDF</a>)</li>
<li><a href="https://www.nxp.com/webapp/Download?colCode=K66P144M180SF5RMV2">Kinetis K66 Reference Manual</a> (<a href="../K66P144M180SF5RMV2.pdf">PDF</a>)</li>
</ul>
<p>In this last lab of the course, we'll use program in assembly language and C programming language interchangeablely and explore the advantage and disadvantage of using a high-level language.</p>
<h2 id="procedures">Procedures</h2>
<h3 id="reading-input-using-polling">Reading Input using Polling</h3>
<ol>
<li>
<p>First, let's setup out project in a similar manner as Lab 7. Create a new project ensure the following driver is available in addition to the default settings.</p>
<ul>
<li>pit</li>
</ul>
<p>If there are missing driver and SDK components from your project, you may add them at any time by clicking <strong>Manage SDK Component</strong> at the top of the project explorer or <strong>Right click on the project &gt; SDK Management &gt; Manage SDK Component</strong>.</p>
</li>
<li>
<p>Use the <strong>ConfigTools &gt; Config Tools Overview</strong> or right click on your project in the <strong>Project Explorer</strong> and Open the <strong>MCUXpresso Config Tools &gt; Open Tools Overview</strong> windows to enable he following:</p>
<p>Under Pins &gt; Functional groups, ensure the followings are enabled:</p>
<ul>
<li>BOARD_InitPins</li>
<li>BOARD_InitBUTTONsPins</li>
<li>BOARD_InitLEDsPins</li>
</ul>
<p>By enabling the above, you are updating the clock gate and pin settings so their respective port can be used.</p>
<p>Remember to click <strong>Update Code</strong> once done.</p>
</li>
<li>
<p>Leave all the <code>BOARD_Init...</code> function in your <code>main.c</code> as is then replace the remaining codes with the following:</p>
<pre><code>/* setup the switch pin config as output per fsl_gpio.h */
gpio_pin_config_t sw_config = {
    kGPIO_DigitalInput,
    0,
};

/* setup the led pin config as output per fsl_gpio.h */
gpio_pin_config_t led_config = {
    kGPIO_DigitalOutput,
    0,
};

/* setup the switch and led pins as per fsl_gpio.h */
/* the gpio and pin keyword can be found in board.h */
GPIO_PinInit(BOARD_SW3_GPIO, BOARD_SW3_GPIO_PIN, &amp;sw_config);
GPIO_PinInit(BOARD_LED_RED_GPIO, BOARD_LED_RED_GPIO_PIN, &amp;led_config);
LED_RED_OFF(); // ensure the red led is off

PRINTF("\r\n --- Program Start --- \r\n");

while(1) {

    /* we'll use polling instead of interrupt to listen for button press (LOW) */
    if (GPIO_PinRead(BOARD_SW3_GPIO, BOARD_SW3_GPIO_PIN) == 0) {
        // button pressed
        LED_RED_ON();
        delay(); // delay so we can see the LED turn on
        LED_RED_OFF();
    }

}

return 0 ;
</code></pre>
<p>Also add the following <code>delay()</code> function to your code:</p>
<pre><code>void delay(void)
{
    volatile uint32_t i = 0;
    /* at 120MHz, 120,000,000 instructions = 1s */
    /* for K66 at 180MHz, 180,000,000 instructions = 1s */
    for (i = 0; i &lt; 120000000; ++i)
    {
        __asm("NOP"); /* delay */
    }
}
</code></pre>
<p>Now that we know how to program the K64 (or K66) processor using assembly, we can use some of the built-in functions and keywords from the SDK to help us with programming the board. There are no compenhensive manual on all the helper functions and keywords aviable. The best place to look is their respecitve library file. This also allow us to write one set of code for multiple processors as long as the helper functions and keywords are available. </p>
</li>
<li>
<p>Build and Debug, then Run he code using <strong>Resume (F8)</strong>. Press switch 2 and see the red LED turn on and off.</p>
</li>
<li>
<p>What happens when you press the switch when the LED is ON? How is the approach of using polling to read input differ then using interrupt? Which one is better? Submit your answer on Blackboard.</p>
</li>
</ol>
<h3 id="code-optimization">Code Optimization</h3>
<p>In class, we discussed various ways on code optimizing. One key thing to remember is shorter code does not means faster code.</p>
<p>A Taylor Series expansion is a way of finding the approximiate value of a function. The Taylor Series expansion of a Sine function is given as follow:</p>
<p>
<script type="math/tex; mode=display">
sin(x) = x - \frac{x^3}{3!} + \frac{x^5}{5!} - \frac{x^7}{7!} + ...
</script>
</p>
<p>Each term is generalized to:</p>
<p>
<script type="math/tex; mode=display">
\textrm{Term}_n = (-1)^n \frac{x^{(2n + 1)}}{(2n + 1)!}
</script>
</p>
<ol>
<li>
<p>Go to <strong>ConfigTools &gt; Peripherals</strong> from the top menu. In the "Components" tab, Under "Peripheral drivers (Device specific)" add the "PIT" configuration components. Set up the PIT at <strong>1us</strong> (one microsecond interval).</p>
</li>
<li>
<p>Add a Global variable <code>loop_timer</code> and the PIT ISR at the end of your code. We'll use them to measure execution time.</p>
<pre><code>volatile static long timer_counter = 0;
</code></pre>
<p>PIT ISR:</p>
<pre><code>void PIT_CHANNEL_0_IRQHANDLER(void) /*ISR to process PIT channel 0 interrupts*/
{
    PIT_ClearStatusFlags(PIT, PIT_CHANNEL_0, kPIT_TimerFlag);
    //clear PIT channel 0 interrupt status flag
    timer_counter++;
}
</code></pre>
</li>
<li>
<p>Next, we have a few helper functions to help calculate the Taylor Series expansion.</p>
<pre><code>/* factorial calculation */
int factorial(int num) {
    int result = 1;
    int i = 0;
    for (i = 1; i &lt;= num; i++) {
        result *= i;
    }
    return result;
}

/* power calculation */
float pow(float base, int exp) {
    float result = 1.0;
    int i = 0;
    for (i = 0; i &lt; exp; i++) {
        result *= base;
    }
    return result;
}

/* each taylor series term */
float taylor_term(float x, int n) {
    float result = 0.0;
    int degree = n * 2 + 1;
    result = pow(x, degree) / factorial(degree);
    result *= (n % 2 == 0 ? 1.0 : -1.0);
    return result;
}

/* taylor series approximation */
float sin_taylor(float x) {
    float result = 0.0;
    int degree = 11;
    int terms = (degree + 1) / 2;
    int i = 0;
    for (i = 0; i &lt; terms; i++) {
        result += taylor_term(x, i);
    }
    return result;
}
</code></pre>
</li>
<li>
<p>Next, change all of the from the <code>printf</code> statement onward to:</p>
<pre><code>float x = 0.0;
float sin_x = 0.0;
const float pi = 3.1416;
int xs[4000] = {0};
int sin_xs[4000] = {0};
int end = 0;
int i = 0;
long elasped_time = 0;

PIT_StartTimer(PIT_PERIPHERAL, PIT_CHANNEL_0);

while(1) {

    if (GPIO_PinRead(BOARD_SW3_GPIO, BOARD_SW3_GPIO_PIN) == 0) {
        LED_RED_ON();

        PRINTF("\r\n --- SIN Calculation Start --- \r\n");

        x = 0.0;
        i = 0;
        timer_counter = 0; // reset timer counter and start

        while (x &lt; pi) {
            sin_x = sin_taylor(x); // calculate sin(x) using Taylor Series
            /* save everything as integer of (x1000) to make it faster for print*/
            xs[i] = (int)(x*1000.0);
            sin_xs[i] = (int)(sin_x*1000.0);
            i++;
            x += (pi / 1000.0);
        }

        elasped_time = timer_counter; // timer end

        end = i;

        for (i = 0; i &lt; end; i++) {
            PRINTF("x = %d, sin_x = %d\r\n", xs[i], sin_xs[i]);
        }

        PRINTF("\r\n --- SIN Calculation End --- \r\n");
        PRINTF("\r\n --- time = %ld --- \r\n", elasped_time);

        LED_RED_OFF();
    }
}
return 0;
</code></pre>
</li>
<li>
<p>Build and Debug, then Run he code using <strong>Resume (F8)</strong>. Press switch 2 and see the red LED turn on and off. Everytime when you press switch 2, <script type="math/tex">sin(x)</script> calculation from <script type="math/tex">0</script> to <script type="math/tex">\pi</script> are calculated at one-thousand intervals. If you open the <strong>Serial Monitor (Terminal)</strong>, it'll say the execution took about 100ms (or 70ms for K66).</p>
<p>The output should be similar to this:</p>
<pre><code>...
x = 3122, sin_x = 18
x = 3125, sin_x = 15
x = 3129, sin_x = 12
x = 3132, sin_x = 8
x = 3135, sin_x = 5
x = 3138, sin_x = 2

--- SIN Calculation End ---

--- time = 109995 ---
</code></pre>
<p>The above value is obtained using the K64F processor. If you are using a K66F processor, it will be around 70,000 us.</p>
</li>
</ol>
<h2 id="post-lab-questions">Post-Lab Questions</h2>
<p>Using the skills and knowledge acquired from this lab, answer the following post-lab question(s) on Blackboard. Due one week after the lab.</p>
<ol>
<li>
<p>How is the approach of using polling to read input differ then using interrupt? Which one is better? Submit your answer on Blackboard.</p>
</li>
<li>
<p>The Taylor Series expansion code is written in a manner that's modular and somewhat easy to understand but not in an optimized manner in terms of fast execution. Using techniques that you've learned in class and your knowledge of assembly instruction, modify the code between timer start and timer end, including the helper function and any related variables, so there's at least 20% improvement in speed to execute the code. For every change and optimization you made, provide a brief reason on how it improve execution time.</p>
<p>Hints and limiations:</p>
<ul>
<li>You may modify the code in C or re-write the code in assembly or use inline assembly</li>
<li>You may add or remove any variables or functions</li>
<li>The degree of the approximation is fixed at 11 (ie. it does not need to be a variable)</li>
<li>You may perform pre-calculation as you see fit</li>
<li>sin(x) must be calculated inside the while loop using taylor series expansion, ie. Term1 + Term2 + ...</li>
<li>You cannot use a SIN function lookup table</li>
</ul>
<p>Paste your code, explanation of every changes, and a screenshot of the terminal output before and after optimization on blackboard. The output value after optimization should be very similar to the value after optimization.</p>
<p><strong>Challenge:</strong> Achieve at least 50% improvement in speed.</p>
</li>
</ol>
<h2 id="reference">Reference</h2>
<p>[1] Yiu, J. (2013). The Definitive Guide to ARM® Cortex®-M3 and Cortex®-M4 Processors. (3rd ed.). Elsevier Science &amp; Technology.</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
