<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Lab 5 : More Branching, Subroutine, and Stack - BSA Lab Manuals</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lab 5 : More Branching, Subroutine, and Stack";
        var mkdocs_page_input_path = "seh500/lab5.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> BSA Lab Manuals
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Lab Manuals</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../ses250/">SES250 Electromagnatics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../">SEH500 Microprocessors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sep600/">SEP600 Embedded Systems</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sea700/">SEA700 Robotics</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">BSA Lab Manuals</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Lab 5 : More Branching, Subroutine, and Stack</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lab-5-more-branching-subroutine-and-stack">Lab 5 : More Branching, Subroutine, and Stack</h1>
<p><font size="5">
Seneca College</br>
SEH500 Microprocessors and Computer Architecture
</font></p>
<h2 id="introduction">Introduction</h2>
<p>Documentation of the Cortex-M4 instruction set can be found here:</p>
<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001">Arm Cortex-M4 Processor Technical Reference Manual Revision</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0403/latest/">ARMv7-M Architecture Reference Manual</a></li>
</ul>
<p>In the previous lab, we explored how to use basic branching to control the flow of a program. In this lab, we'll further explore branching and use the stack point to create subroutine and function call procedure.</p>
<h3 id="review-of-branching-instructions-with-link">Review of Branching Instructions with Link</h3>
<table>
<thead>
<tr>
<th>Mnemonic</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>B label</td>
<td>Branch</td>
</tr>
<tr>
<td>B{cond} label</td>
<td>Branch with condition</td>
</tr>
<tr>
<td>BL label</td>
<td>Branch with Link</td>
</tr>
<tr>
<td>BL{cond} label</td>
<td>Branch with Link with condition</td>
</tr>
<tr>
<td>BX Rm</td>
<td>Branch to register value</td>
</tr>
<tr>
<td>BX{cond} Rm</td>
<td>Branch to register value with condition</td>
</tr>
<tr>
<td>BLX Rm</td>
<td>Branch with Link to register value</td>
</tr>
<tr>
<td>BLX{cond} Rm</td>
<td>Branch with Link to register value with condition</td>
</tr>
</tbody>
</table>
<p>See below for conditions that are set by a compare, usually CMP, instruction. The CMP Rm, Rn instruction operates Rm-Rn for the sole purpose of setting the condition flags.</p>
<h3 id="review-of-branching-conditions">Review of Branching Conditions</h3>
<table>
<thead>
<tr>
<th>Suffix</th>
<th>Flags</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>EQ</td>
<td>Z = 1</td>
<td>Equal</td>
</tr>
<tr>
<td>NE</td>
<td>Z = 0</td>
<td>Not equal</td>
</tr>
<tr>
<td>CS or HS</td>
<td>C = 1</td>
<td>Higher or same, unsigned, &gt;=</td>
</tr>
<tr>
<td>CC or LO</td>
<td>C = 0</td>
<td>Lower, unsigned, &lt;</td>
</tr>
<tr>
<td>MI</td>
<td>N = 1</td>
<td>Negative</td>
</tr>
<tr>
<td>PL</td>
<td>N = 0</td>
<td>Positive or zero</td>
</tr>
<tr>
<td>VS</td>
<td>V = 1</td>
<td>Overflow</td>
</tr>
<tr>
<td>VC</td>
<td>V = 0</td>
<td>No overflow</td>
</tr>
<tr>
<td>HI</td>
<td>C = 1 and Z = 0</td>
<td>Higher, unsigned, &gt;</td>
</tr>
<tr>
<td>LS</td>
<td>C = 0 or Z = 1</td>
<td>Lower or same, unsigned, &lt;=</td>
</tr>
<tr>
<td>GE</td>
<td>N = V</td>
<td>Greater than or equal, signed, &gt;=</td>
</tr>
<tr>
<td>LT</td>
<td>N != V</td>
<td>Less than, signed, &lt;</td>
</tr>
<tr>
<td>GT</td>
<td>Z = 0 and N = V</td>
<td>Greater than, signed, &gt;</td>
</tr>
<tr>
<td>LE</td>
<td>Z = 1 and N != V</td>
<td>Less than or equal, signed, &lt;=</td>
</tr>
<tr>
<td>AL</td>
<td>Can have any value</td>
<td>Always. This is the default when no suffix is specified.</td>
</tr>
</tbody>
</table>
<h3 id="register-use-in-the-arm-procudure-call-standard">Register Use in the ARM Procudure Call Standard</h3>
<p>So far, we've been using the general purpose registers freely without much condition of what there are ideal for or any standards. However, below is a common convention to consider when using registers:</p>
<table>
<thead>
<tr>
<th>Purpose</th>
<th>Register</th>
</tr>
</thead>
<tbody>
<tr>
<td>Argument 1</td>
<td>r0</td>
</tr>
<tr>
<td>Argument 2</td>
<td>r1</td>
</tr>
<tr>
<td>Argument 3</td>
<td>r2</td>
</tr>
<tr>
<td>Argument 4</td>
<td>r3</td>
</tr>
<tr>
<td>Variable 1</td>
<td>r4</td>
</tr>
<tr>
<td>Variable 2</td>
<td>r5</td>
</tr>
<tr>
<td>Variable 3</td>
<td>r6</td>
</tr>
<tr>
<td>Variable 4</td>
<td>r7</td>
</tr>
<tr>
<td>Variable 5</td>
<td>r8</td>
</tr>
<tr>
<td>Variable 6 / Stack Base</td>
<td>r9</td>
</tr>
<tr>
<td>Variable 7 / Stack Limit</td>
<td>r10</td>
</tr>
<tr>
<td>Variable 8 / Frame Pointer</td>
<td>r11</td>
</tr>
<tr>
<td>Intra-Procedure Scratch</td>
<td>r12</td>
</tr>
<tr>
<td>Stack Pointer (SP)</td>
<td>r13</td>
</tr>
<tr>
<td>Link Register (LR)</td>
<td>r14</td>
</tr>
<tr>
<td>Program Counter (PC)</td>
<td>r15</td>
</tr>
</tbody>
</table>
<p>Note that even though SP, LR and PC are special register used by the processor, they can still be modified with code and used the same way as other registers.</p>
<h3 id="introduction-to-stack">Introduction to Stack</h3>
<p>The stack is a data structure, known as last in first out (LIFO). In a stack, items entered at one end and leave in the reversed order. Stacks in microprocessors are implemented by using a stack pointer to point to the top of the stack in memory.</p>
<p>As items are added to the stack (pushed), the stack pointer is moving up, and as items are removed from the stack (pulled or popped), the stack pointer is moved down.</p>
<p>ARM stacks are very flexible since the implementation is completely left to the software. Stack pointer is a register that points to the top of the stack. In the ARM processor, any one of the general purpose registers could be used as a stack pointer. Since it is left to the software to implement a stack, different implemenation choices result different types of stacks. Normally, there are two types of the stacks depending on which way the stack grows.</p>
<ol>
<li>
<p>Ascending Stack - When items are pushed on to the stack, 
    the stack pointer is increasing.  That means the stack grows 
    towards higher address.</p>
</li>
<li>
<p>Descending Stack - When items are pushed on to the stack, 
    the stack pointer is decreasing.  That means the stack is growing 
    towards lower address.</p>
</li>
</ol>
<p>Depending on what the stack pointer points to we can categorize the stacks into the following two types:</p>
<ol>
<li>Empty Stack - Stack pointer points to the location in which the next/first item 
    will be stored. 
    e.g. A push will store the value, and increment the stack pointer 
    for an  Ascending Stack. </li>
<li>Full Stack - Stack pointer points to the location in which the last item 
    was stored. 
    e.g. A pop will decrement the stack pointer and pull the value 
    for an Ascending Stack.</li>
</ol>
<p>So now we can have four possible types of stacks. They are:</p>
<ol>
<li>full-ascending stack,</li>
<li>full-descending stack,</li>
<li>empty-ascending stack,</li>
<li>empty-descending stack.</li>
</ol>
<p>They can be implemented by using the register load and store instructions.</p>
<p>Here are some instructions used to deal with stack:</p>
<pre><code>PUSH {R3}             @ Push R3 onto the stack
PUSH {R0, R4-R7}      @ Push R0, R4, R5, R6, R7 onto the stack
PUSH {R2, LR}         @ Push R2 and the link register onto the stack
POP  {R0, R5, PC}     @ pop and return from subroutine, branch to PC
POP  {R3}             @ Pop stack value and save to R3
</code></pre>
<p>Push registers onto and pop registers off a full-descending stack.</p>
<h3 id="subroutine-and-stack">Subroutine and Stack</h3>
<p>A subroutine call can be implemented by pushing the return address on the stack and then jumping to the branch target address. When the subroutine is done, remember to pop out the saved information so that it will be able to return to the next instruction immediately after the calling point.</p>
<h2 id="preparation">Preparation</h2>
<blockquote>
<h3 id="lab-preparation-question">Lab Preparation Question</h3>
<ol>
<li>Read over the lab and write a pseudocode for the post-lab exercise 4. It should just be a small modification from the one your did in the previous lab. Submission on Blackboard is not required.</li>
</ol>
</blockquote>
<h2 id="procedures">Procedures</h2>
<p>Similar to the previous lab.</p>
<ol>
<li>
<p>Open MCUXpresso then start a new C/C++ project based on the Freedom board model that you have.</p>
</li>
<li>
<p>In the new project configuration, rename the project then leave all other settings as default.</p>
</li>
<li>
<p>Once the project is created, rename the C-code file from ".c" to ".s". If the IDE is not allowing you to rename, delete the C-code file and create a new file of the same name but with the extension ".s".</p>
</li>
<li>
<p>In this example, let's take a look as a simple subroutine call. Replace the code within the file with the following:</p>
<p><hr/><pre>
.syntax unified             @ unified syntax used
.cpu cortex-m4              @ cpu is cortex-m4
.thumb                      @ use thumb encoding</p>
<p>.data                       @ put data in the data section
sump:   .word sum           @ declare a pointer to sum
sump2:  .word sum2          @ declare a pointer to sum2
n:      .word 5             @ declare variable n with value of 5
sum:    .word 0             @ declare sum with value of 0
sum2:   .word 0             @ declare sum2 with value of 0</p>
<p>.text                       @ put code in the code section</p>
<p>.global sumup               @ declare sumup as a global variable
.type sumup, %function      @ set sumup to function type</p>
<p>sumup:
    add     r0, r0, r1      @ R0 = ? after first execution only
    subs    r1, r1, #1      @ R1 = ? after first execution only
    bgt     sumup           @ Branch back if not done
    bx      lr              @ PC = ?, LR = ?
                            @ After execution, PC = ?</p>
<p>.global main                @ declare main as a global variable
.type main, %function       @ set main to function type</p>
<p>main:
    ldr     r1, =n          @ Load count into R1
    ldr     r1, [r1]        @ R1 = ?
    mov     r0, #0          @ Clear accumulator R0
    bl      sumup            @ PC = ?, LR = ?
    ldr     r3, =sump       @ Load address of SUM to R3
    ldr     r3, [r3]        @ R3 = ?
    str     r0, [r3]        @ Store SUM
    ldr     r4, [r3]        @ R4 = ?
    mov     r7, #8
    ldr     r5, =sump2      @ Load address of SUM2 to R5
    ldr     r5, [r5]        @ R5 = ?
    str     r7, [r5]        @ Store SUM2
    ldr     r6, [r5]        @ R6 = ?</p>
<p>stop:                           @ define a new label called stop
    nop                         @ do nothing
    b       stop                @ jump back label stop to form a loop
</pre><hr/></p>
</li>
<li>
<p>Execute the code above, pay attention to what is happening in each register and record their value as per the code comment. Afterward, take a look at the memory address where the variable is saved then take a screenshot showing the memory address along with the value. Submit your code and screenshot it as part of the post-lab.</p>
</li>
<li>
<p>In this code, we'll take a look at subroutine and stack. Replace the code within the file with the following:</p>
<p><hr/><pre>
.syntax unified             @ unified syntax used
.cpu cortex-m4              @ cpu is cortex-m4
.thumb                      @ use thumb encoding</p>
<p>.data                       @ put data in the data section
sump:   .word sum           @ declare a pointer to sum
sump2:  .word sum2          @ declare a pointer to sum2
n:      .word 5             @ declare variable n with value of 5
sum:    .word 0             @ declare sum with value of 0
sum2:   .word 0             @ declare sum2 with value of 0</p>
<p>.text                       @ put code in the code section</p>
<p>.global function1           @ declare as a global variable
.type function1, %function  @ set to function type</p>
<p>function1:
    push    {r5, lr}        @ Save values in the stack
                            @ which address did R5 and LR got saved to?
    mov     r5, #8          @ Set initial value for the delay loop<br />
delay:
    subs    r5, r5, #1      @ R5 = ? after first execution
    bne     delay
    pop     {r5, pc}        @ pop out the saved value from the stack, 
                            @ check the value in the R5
                            @ and see if it is the saved value
                            @ R5 = ?, PC = ?</p>
<p>.global main                @ declare main as a global variable
.type main, %function       @ set main to function type</p>
<p>main:
    mov     r0, #1          @ SP = ? then memory monitor to SP address
    mov     r3, #0x75
    push    {r0, r3}        @ SP = ? which address did #0x75
                            @ and #1 got saved to?
    mov     r0, #6          @ R0 = ?
    mov     r3, #7          @ R3 = ?
    pop     {r0, r3}        @ after pop, R0 = ?, R3 = ?, SP = ?
                            @ did the value in memory address changed</p>
<p>loop:
    add     r0, r0, #1
    cmp     r0, #5
    bne     loop
    mov     r5, #9          @ prepare for function call
    bl      function1       @ PC = ?, LR = ?, R5 = ?
    mov     r3, #12</p>
<p>stop:                           @ define a new label called stop
    nop                         @ do nothing
    b       stop                @ jump back label stop to form a loop
</pre><hr/></p>
</li>
<li>
<p>Execute the code above, pay attention to what is happening in each register and record their value as per the code comment. Afterward, take a look at the memory address where the stack is saved then take a screenshot showing the memory address along with the value. Submit your code and screenshot it as part of the post-lab.</p>
</li>
</ol>
<h2 id="post-lab-questions">Post-Lab Questions</h2>
<p>Using the skills and knowledge acquired from this lab, answer the following post-lab question(s) on Blackboard. Due one week after the lab.</p>
<ol>
<li>
<p>Execute the code from step 4 then answer the questions in the comment. Copy and paste your code with your answers along with any screenshots into Blackboard.</p>
</li>
<li>
<p>Execute the code from step 6 then answer the questions in the comment. Copy and paste your code with your answers along with any screenshots into Blackboard.</p>
</li>
<li>
<p>Rewrite the program from the last lab in assembly language that counts how many vowels and non-vowels are in "SEH500 is very cool! (your name here)" (REPLACE (your name here) with your name). But this time, you must use at least one subroutine in your code along with the stack.</p>
<ul>
<li>Hint: put your string into memory using the .string directive</li>
<li>use R0 to hold the address for the string or character</li>
<li>use R1 as the counter for vowel</li>
<li>use R2 as the counter for non-vowel</li>
</ul>
</li>
<li>
<p>For the code above, at the end of execution, take a screenshot of your register bank, and your memory space showing the string then copy your code into Blackboard.</p>
</li>
</ol>
<h2 id="reference">Reference</h2>
<p>[1] Yiu, J. (2013). The Definitive Guide to ARM® Cortex®-M3 and Cortex®-M4 Processors. (3rd ed.). Elsevier Science &amp; Technology.</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
