<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Lab 3: PWM and DAC - BSA Lab Manuals</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lab 3: PWM and DAC";
        var mkdocs_page_input_path = "sep600/lab3.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> BSA Lab Manuals
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Lab Manuals</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../ses250/">SES250 Electromagnatics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../seh500/">SEH500 Microprocessors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../">SEP600 Embedded Systems</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sea700/">SEA700 Robotics</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">BSA Lab Manuals</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Lab 3: PWM and DAC</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lab-3-pwm-and-dac">Lab 3: PWM and DAC</h1>
<p><font size="5">
Seneca Polytechnic</br>
SEP600 Embedded Systems
</font></p>
<h2 id="introduction">Introduction</h2>
<p>Documentation for the Cortex-M4 instruction set, the board user's guide, and the microcontroller reference manual can be found here:</p>
<p>Documentation for the Freedom K64 and K66 boards and their microcontrollers can be found here:</p>
<ul>
<li><a href="https://www.nxp.com/webapp/Download?colCode=FRDMK64FUG">FRDM-K64F Freedom Module User’s Guide</a> (<a href="../FRDMK64FUG.pdf">PDF</a>)</li>
<li><a href="https://www.nxp.com/webapp/Download?colCode=K64P144M120SF5RM">Kinetis K64 Reference Manual</a> (<a href="../K64P144M120SF5RM.pdf">PDF</a>)</li>
<li><a href="https://os.mbed.com/platforms/FRDM-K64F/">FRDM-K64F Mbed Reference</a></li>
<li><a href="https://os.mbed.com/teams/Freescale/wiki/frdm-k64f-pinnames">FRDM-K64F Mbed Pin Names</a></li>
<li><a href="https://www.nxp.com/webapp/Download?colCode=FRDMK66FUG">FRDM-K66F Freedom Module User’s Guide</a> (<a href="../FRDMK66FUG.pdf">PDF</a>)</li>
<li><a href="https://www.nxp.com/webapp/Download?colCode=K66P144M180SF5RMV2">Kinetis K66 Reference Manual</a> (<a href="../K66P144M180SF5RMV2.pdf">PDF</a>)</li>
<li><a href="https://os.mbed.com/platforms/FRDM-K66F/">FRDM-K66F Mbed Reference</a></li>
<li><a href="https://os.mbed.com/teams/NXP/wiki/FRDM-K66F-Pinnames">FRDM-K66F Mbed Pin Names</a></li>
</ul>
<p>Documentation for the Cortex-M4 instruction set can be found here:</p>
<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001">Arm Cortex-M4 Processor Technical Reference Manual Revision</a> (<a href="../Cortex-M4-Proc-Tech-Ref-Manual.pdf">PDF</a>)<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001/Programmers-Model/Instruction-set-summary/Table-of-processor-instructions">Table of Processor Instructions</a></li>
</ul>
</li>
<li><a href="https://developer.arm.com/documentation/ddi0403/latest/">ARMv7-M Architecture Reference Manual</a> (<a href="../DDI0403E_e_armv7m_arm.pdf">PDF</a>)</li>
</ul>
<h3 id="pulse-width-modulation-pwm">Pulse Width Modulation (PWM)</h3>
<p>As discussed in class and tested in Lab 2, Pulse Width Modulation (PWM) is a technique used to control the amount of power delivered to an electrical device by varying the width of the pulses in a signal. It involves turning a signal on and off at a high frequency, with the proportion of time the signal is "on" (the duty cycle) determining the average voltage or power delivered. A higher duty cycle means more power, while a lower duty cycle reduces power. PWM is widely used in applications such as motor control, light dimming, and power regulation because it allows for efficient energy use and precise control of the output. It is favored for its simplicity, cost-effectiveness, and ability to operate with minimal heat generation compared to traditional methods of voltage regulation.</p>
<p><img alt="Figure 3.1" src="../lab3-pwm.png" /></p>
<p><em><strong>Figure 3.1</strong> PWM</em></p>
<h3 id="digital-to-analog-converter-dac">Digital-to-Analog Converter (DAC)</h3>
<p>A Digital-to-Analog Converter (DAC) is an essential component in modern electronic systems that converts digital data, usually in binary form, into an analog signal. This process is crucial for applications like audio playback, where the digital data stored in devices like smartphones or computers must be transformed into analog signals to drive speakers or headphones. The quality of a DAC can significantly influence sound fidelity, as it directly impacts the smoothness and accuracy of the analog signal. DACs are used in a wide variety of devices, from audio equipment and televisions to medical devices and instrumentation, playing a key role in bridging the digital world with the analog one.</p>
<p><img alt="Figure 3.2" src="../lab3-dac.png" /></p>
<p><em><strong>Figure 3.2</strong> DAC Output</em></p>
<h2 id="materials">Materials</h2>
<ul>
<li>Safety glasses (PPE)</li>
<li>Breadboard</li>
<li>Jumper wires</li>
<li>Various 1kΩ–10kΩ resistors</li>
<li>Various 0.1µF–10µF capacitors</li>
<li>(2x) NPN Transistors (2N2222, 2N3904, or similar)</li>
<li>(2x) LEDs</li>
</ul>
<h2 id="preparation">Preparation</h2>
<p>Read over the lab manual for this lab and acquire the necessary materials.</p>
<h2 id="procedures">Procedures</h2>
<h3 id="part-1-pwm-output-as-analog-output">Part 1: PWM Output as Analog Output</h3>
<p><img alt="Figure 3.3" src="../lab3-rc-circuit.png" /></p>
<p><em><strong>Figure 3.3</strong> PWM Output with RC Smoothing Circuit.</em></p>
<ol>
<li>
<p>Acquire a breadboard, a resistor, a capacitor, and jumper wires to assemble the circuit shown above. Attach the PWM signal to a PWM-capable pin of your microcontroller (pins with a purple PWM label in the pinout diagram from <a href="../lab2/">Lab 2</a>). Refer to the microcontroller board manual for details on pin assignment.</p>
<p><div style="padding: 15px; border: 1px solid red; background-color: orange; color: white;"><font size="5">If you are using a polarized capacitor, ensure the polarity of your connection is correct.</font></div></p>
</li>
<li>
<p>Calculate the RC time constant for your circuit, as you will need this for your program.</p>
<p>
<script type="math/tex; mode=display"> \tau = RC </script>
</p>
</li>
<li>
<p>Write code to set up the PWM output pin.</p>
<pre><code>int main()
{
    ...
    PwmOut pwm(PTXXX); // Replace PTXXX with your PWM pin
    ...
}
</code></pre>
</li>
<li>
<p>Add the following code to start the PWM output. Use a period that is at least twice the value of your RC time constant.</p>
<pre><code>int main()
{
    ...
    pwm.period(XXXf); // period in s
    pwm.write(0.50f); // duty cycle 0.5f = 50%
    ...
}
</code></pre>
</li>
<li>
<p>Turn on the DSO and connect CH1 to your PWM output pin and CH2 to the RC circuit output signal. The DSO ground should be common with your circuit ground.</p>
</li>
<li>
<p>Run and test your program, then adjust the DSO so that both CH1 and CH2 are visible on the display. Your signal should look similar to the graph below.</p>
<p><img alt="Figure 3.3" src="../lab3-rc-pwm.png" /></p>
<p><em><strong>Figure 3.3</strong> PWM Signal after RC Smoothing.</em></p>
</li>
<li>
<p>What you have now is a poorly filtered analog output. Adjust your PWM settings (e.g., period) so that there is less than 10% fluctuation between the high and low voltages after the RC filter (CH2). (The peak-to-peak voltage of the output should be less than 0.33V.)</p>
<p><strong>Hint:</strong> Think about the discharging and transient response of the capacitor.</p>
<blockquote>
<p><strong>Lab Question:</strong> What is the PWM period (and frequency) needed to achieve this?</p>
<p><strong>Lab Question:</strong> Can the same result be achieved by modifying the circuit instead of modifying the PWM settings?</p>
</blockquote>
</li>
<li>
<p>Do NOT disassemble this circuit. Be prepared to demonstrate its output at the end of the lab.</p>
</li>
</ol>
<h3 id="part-2-pwm-vs-dac-as-current-driver">Part 2: PWM vs DAC as Current Driver</h3>
<p>Next, we'll set up a PWM and a DAC to compare the difference between the outputs.</p>
<p><img alt="Figure 3.4" src="../lab3-current-driver.png" /></p>
<p><em><strong>Figure 3.4</strong> DAC and PWM Output</em></p>
<ol>
<li>
<p>Set up <strong>two</strong> current driver circuits as shown above. Connect a PWM output pin to the input signal of the first current driver and a DAC output pin to the input signal of the second current driver. Connect CH1 and CH2 of the DSO to the points of the first and second current driver circuits, respectively. Refer to the microcontroller board manual for details on pin assignment.</p>
</li>
<li>
<p>Use your microcontroller's 3.3V output and GND connection for the current driver circuit. Select <script type="math/tex">R_B</script> and <script type="math/tex">R_L</script> appropriately.</p>
<ul>
<li>
<script type="math/tex">R_L</script> should allow only 20mA of current to pass through the LED.</li>
<li>
<script type="math/tex">R_B</script> should allow the NPN transistor to drive at least 20mA of current when it's fully ON at saturation.</li>
</ul>
<p>Refer to the NPN transistor's datasheet for the gain value. It is often refered to as <script type="math/tex">h_{FE}</script> by maunfacturer. The following formula from lecture slides might be useful for your calculation.</p>
<p>
<script type="math/tex; mode=display"> I_C = \beta I_B </script>
<script type="math/tex; mode=display"> V_{IN} - V_{BE} = I_B R_B </script>
</p>
</li>
<li>
<p>Modify your code to add a DAC output and a second PWM output. Since there's only one DAC available, the DAC pin name is fixed.</p>
<pre><code>int main()
{
    ...
    AnalogOut aout(DAC0_OUT); // Set up DAC
    PwmOut pwm2(PTXXX); // Replace PTXXX with your PWM pin
    ...
    ...
    aout = 0.5f; // Use the same output setting as PWM
    pwm2.period(0.01f); // Period in s
    pwm2.write(0.50f); // Duty cycle 0.5f = 50%
    ...
}
</code></pre>
</li>
<li>
<p>Turn on the DSO and run the program. You should also see a PWM square wave on the channel connected to the PWM circuit and a 1.65V flat line on the channel connected to the DAC. Did both LEDs turn on? If not, try increasing the output value until the LED turn on.</p>
</li>
<li>
<p>Modify your code so the two LEDs both start from 0% brightness and then gradually (at least 10 steps) increase to 100% brightness over a period of 1 second. Afterward, gradually (at least 10 steps) decrease to 0% brightness over a period of 1 second.</p>
<p>At the end, you should see something similar to the figure below on your DSO.</p>
<p><img alt="Figure 3.5" src="../lab3-dac-pwm.png" /></p>
<p><em><strong>Figure 3.5</strong> DAC and PWM Output</em></p>
<blockquote>
<p><strong>Lab Question:</strong> What difference do you notice between the two LEDs? Which method is better?</p>
<p><strong>Lab Question:</strong> After the LED reaches full brightness, at what PWM duty cycle do you start noticing a decrease in LED brightness?</p>
</blockquote>
</li>
<li>
<p>Ensure you fully understand the concepts of PWM, the RC circuit, DAC, and the current driver.</p>
</li>
</ol>
<p>Once you've completed all the steps above (and ONLY when you are ready, as you'll only have one opportunity to demo), ask the lab professor or instructor to come over and demonstrate that you've completed the lab. You may be asked to explain some of the concepts you've learned in this lab.</p>
<h2 id="references">References</h2>
<ul>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.16/apis/i-o-apis.html">mbed I/O APIs</a></li>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.16/apis/pwmout.html">PwmOut</a></li>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.16/apis/analogout.html">AnalogOut</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
