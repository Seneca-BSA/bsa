<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Lab 5 : Serial UART and I2C Communication - BSA Lab Manuals</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lab 5 : Serial UART and I2C Communication";
        var mkdocs_page_input_path = "sep600/lab5.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> BSA Lab Manuals
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Lab Manuals</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../ses250/">SES250 Electromagnatics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../seh500/">SEH500 Microprocessors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../">SEP600 Embedded Systems</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sea700/">SEA700 Robotics</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">BSA Lab Manuals</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Lab 5 : Serial UART and I2C Communication</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lab-5-serial-uart-and-i2c-communication">Lab 5 : Serial UART and I2C Communication</h1>
<p><font size="5">
Seneca Polytechnic</br>
SEP600 Embedded Systems
</font></p>
<h2 id="introduction">Introduction</h2>
<p>Documentation for the Cortex-M4 instruction set, the board user's guide, and the microcontroller reference manual can be found here:</p>
<p>Documentation for the Freedom K64 and K66 boards and their microcontrollers can be found here:</p>
<ul>
<li><a href="https://www.nxp.com/webapp/Download?colCode=FRDMK64FUG">FRDM-K64F Freedom Module User’s Guide</a> (<a href="../FRDMK64FUG.pdf">PDF</a>)</li>
<li><a href="https://www.nxp.com/webapp/Download?colCode=K64P144M120SF5RM">Kinetis K64 Reference Manual</a> (<a href="../K64P144M120SF5RM.pdf">PDF</a>)</li>
<li><a href="https://os.mbed.com/platforms/FRDM-K64F/">FRDM-K64F Mbed Reference</a></li>
<li><a href="https://os.mbed.com/teams/Freescale/wiki/frdm-k64f-pinnames">FRDM-K64F Mbed Pin Names</a></li>
<li><a href="https://www.nxp.com/webapp/Download?colCode=FRDMK66FUG">FRDM-K66F Freedom Module User’s Guide</a> (<a href="../FRDMK66FUG.pdf">PDF</a>)</li>
<li><a href="https://www.nxp.com/webapp/Download?colCode=K66P144M180SF5RMV2">Kinetis K66 Reference Manual</a> (<a href="../K66P144M180SF5RMV2.pdf">PDF</a>)</li>
<li><a href="https://os.mbed.com/platforms/FRDM-K66F/">FRDM-K66F Mbed Reference</a></li>
<li><a href="https://os.mbed.com/teams/NXP/wiki/FRDM-K66F-Pinnames">FRDM-K66F Mbed Pin Names</a></li>
</ul>
<p>Documentation for the Cortex-M4 instruction set can be found here:</p>
<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001">Arm Cortex-M4 Processor Technical Reference Manual Revision</a> (<a href="../Cortex-M4-Proc-Tech-Ref-Manual.pdf">PDF</a>)<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001/Programmers-Model/Instruction-set-summary/Table-of-processor-instructions">Table of Processor Instructions</a></li>
</ul>
</li>
<li><a href="https://developer.arm.com/documentation/ddi0403/latest/">ARMv7-M Architecture Reference Manual</a> (<a href="../DDI0403E_e_armv7m_arm.pdf">PDF</a>)</li>
</ul>
<h3 id="serial-universal-asynchronous-receivertransmitter-uart">Serial Universal Asynchronous Receiver/Transmitter (UART)</h3>
<p>Serial UART is a communication protocol commonly used for transmitting and receiving data between devices over a serial interface. It operates asynchronously, meaning that data is sent without needing a clock signal, using start bits, data bits, optional parity bits, and stop bits to structure each data frame. UART is widely used in embedded systems, microcontrollers, and computer communication for its simplicity, low cost, and reliability. Devices communicate by converting parallel data into a serial stream for transmission and converting it back on the receiving end. Typical use cases include connecting peripherals like sensors, GPS modules, and Bluetooth devices to a microcontroller or computer. It typically requires only two wires—one for transmitting data (TX) and one for receiving data (RX)—making it efficient for many small-scale applications.</p>
<h3 id="inter-integrated-circuit-i2c">Inter-Integrated Circuit (I2C)</h3>
<p>I2C is a synchronous, multi-master, multi-slave communication protocol commonly used to connect low-speed peripheral devices like sensors, displays, and memory chips to microcontrollers. It uses only two wires for communication: a serial data line (SDA) and a serial clock line (SCL), allowing multiple devices to share the same bus. I2C operates in a master-slave configuration, where the master device controls the clock and initiates communication with the slave devices. Each device on the bus is assigned a unique address, and data is transferred in packets, which include the address and the data to be sent. I2C is favored for its simplicity, ease of use, and ability to connect multiple devices with minimal wiring, making it ideal for embedded systems and applications where space and resources are limited.</p>
<h2 id="materials">Materials</h2>
<ul>
<li>Safety glasses (PPE)</li>
<li>Freedom K64F or K66F Board</li>
<li>Breadboard</li>
<li>Jumper Wires</li>
<li>(2×) 1kΩ Resistors</li>
<li>LCD Display (Parallel or I2C) (Optional)</li>
</ul>
<h2 id="preparation">Preparation</h2>
<blockquote>
<h3 id="lab-preparation-question">Lab Preparation Question</h3>
<ol>
<li>Read over the lab and understand the procedures.</li>
</ol>
</blockquote>
<h2 id="procedures">Procedures</h2>
<h3 id="part-1-onboard-i2c-accelerometer-and-magnetometer-or-any-i2c-sensor-or-i2c-lcd">Part 1: Onboard I2C Accelerometer and Magnetometer (Or any I2C Sensor or I2C LCD)</h3>
<p>In Part 1, we'll take a look at how to get reading from the onboard accelerometer and magnetometer (or any I2C sensor or send message to a I2C LCD).</p>
<div style="padding: 15px; border: 1px solid orange; background-color: orange; color: black;">
Check to see if the accelerometer is assembled on your board. NXP had a production change in 2023 and no longer assembles the FXOS8700CQ onto the Freedom board. If your board is missing the accelerometer chip (as shown in Figure 4.1 below), this part of the Lab will not work.
</div>

<p>The location U8 on the Freedom Board should be assembled with the FXOS8700CQ accelerometer chip.</p>
<p><img alt="Figure 5.1" src="../lab5-u8.png" /></p>
<p><em><strong>Figure 5.1</strong> Freedom Board with missing FXOS8700CQ accelerometer chip</em></p>
<ol>
<li>
<p>To use the FXOS8700CQ, you'll need to add the FXOS8700CQ library to your project. Start Kiel Studio then go to File &gt; Add Mbed Library to Active Program. When prompted, provide the following link <a href="https://os.mbed.com/teams/NXP/code/FXOS8700Q/">https://os.mbed.com/teams/NXP/code/FXOS8700Q/</a>.</p>
<ul>
<li>If you are using another sensor, find the library for your sensor in the mbed library repository.</li>
<li>If you are using an I2C LCD, use this library: <a href="I2C LCD: https://os.mbed.com/users/sstaub/code/mbedLCDi2c/">https://os.mbed.com/users/sstaub/code/mbedLCDi2c/</a></li>
</ul>
</li>
<li>
<p>The following code depend on the I2C device that you are using. The pins used for connection to the accelerometer on the Freedom board are as follows:</p>
<table>
<thead>
<tr>
<th></th>
<th>K64F</th>
<th>K66F</th>
</tr>
</thead>
<tbody>
<tr>
<td>SDA</td>
<td>PTE25</td>
<td>PTD9</td>
</tr>
<tr>
<td>SCL</td>
<td>PTE24</td>
<td>PTD8</td>
</tr>
</tbody>
</table>
<p>The Freedom have multiple I2Cs. For the K66F, the I2C pins you see on the pinout map are not on the same I2C network as the onboard sensor.</p>
<p>Start your program with the following code to include the proper library and set up I2C.</p>
<pre><code>#include "mbed.h"
#include "FXOS8700Q.h"

I2C i2c(I2C_SDA, I2C_SCL); // replace with I2C pins
</code></pre>
</li>
<li>
<p>Next, we'll create the accelerometer and magnetometer objects using the I2C object we created and the accelerometer's address. You can find the address in the header file.</p>
<pre><code>FXOS8700QAccelerometer acc(i2c, FXOS8700CQ_SLAVE_ADDR1);
FXOS8700QMagnetometer mag(i2c, FXOS8700CQ_SLAVE_ADDR1);
</code></pre>
<blockquote>
<p><strong>Lab Question:</strong> Look into the header file for the FXOS8700Q (or the one for your I2C device) to find the slave address in HEX?</p>
</blockquote>
</li>
<li>
<p>Declare the variables for the sensor data within the <code>main</code> function then enable the sensor. This varies depending on your I2C devices.</p>
<pre><code>motion_data_units_t acc_data, mag_data;
float faX, faY, faZ, fmX, fmY, fmZ, tmp_float;

acc.enable();
mag.enable();
</code></pre>
</li>
<li>
<p>Add a <code>while</code> loop to get accelerometer readings and print it out. You may change the print statement to just integer if you don't want to setup float.</p>
<pre><code>while (true) {
    acc.getAxis(acc_data);
    mag.getAxis(mag_data);
    printf("%3.3f %3.3f\r\n", acc_data.x, mag_data.x);
    ThisThread::sleep_for(500ms);
}
</code></pre>
</li>
<li>
<p>(Optional) Per <a href="https://github.com/ARMmbed/mbed-os/blob/master/platform/source/minimal-printf/README.md">Minimal printf and snprintf</a>, as of mbed OS 6, printf no longer prints floating point by default to save memory. To enable printing of floating point value, enable it by creating a file called <code>mbed_app.json</code> in the root project folder and adding the following code to it.</p>
<pre><code>{
    "target_overrides": {
        "*": {
            "target.printf_lib": "std"
        }
    }
}
</code></pre>
</li>
<li>
<p>If you are using an I2C LCD, you may use the following code to output some message on the display.</p>
<pre><code>#include "mbed.h"
#include "LCD.h"

LCD lcd(D9, D8, D4, D5, D6, D7, LCD16x2); // RS, EN, D4-D7, Type

int main() {

    lcd.cls(); // clear display
    lcd.locate(0, 0); // set cursor location
    lcd.printf("START\n"); // display text
    ThisThread::sleep_for(2s);
    lcd.cls(); // clear display
    lcd.locate(0, 0); // set cursor location
    lcd.printf("Hello World!\n"); // display text

}
</code></pre>
</li>
<li>
<p>Run your program and you should now see accelerometer and magnetometer readings (or the LCD displaying a message). Refer to the FXOS8700Q libraries for other library functions and reading you can get.</p>
<blockquote>
<p><strong>Lab Question:</strong> Try getting readings from different axes to figure out which direction is X, Y, and Z? When there is acceleration in an axis, you'll get acceleration reading on that axis (including gravity).</p>
</blockquote>
</li>
</ol>
<h3 id="part-2-visualize-i2c-signal">Part 2: Visualize I2C Signal</h3>
<ol>
<li>
<p>Power off the Freedom board and connect the SDA pin to CH1 and the SCL pin to CH2 of the oscilloscope. If you are using the K66F board, use I2C1 at PTC11 and PTC10 for this part of the lab.</p>
</li>
<li>
<p>Power the board back on With the I2C code running, adjust the oscilloscope to see the full I2C data frame. Use the "Serial" option under Measure on the right of the face plate to align the I2C signal. If Serial measurement is not available or cannot lock into the I2C signal, you might need to do this manually. If you cannot see the I2C signal, decrease the delay in each loop so data are sent more often and use "Single" reading instead of continuous readings.</p>
<blockquote>
<p><strong>Lab Question:</strong> Using the figure below as a reference, identify the start condition, the address, ACK, data, and stop condition of your I2C signal. You should be able to identify the HEX address you are sending from Part 1.</p>
</blockquote>
<p><img alt="Figure 5.2" src="../lab5-i2c-frame.jpg" /></p>
<p><em><strong>Figure 5.2</strong> I2C data frame [1]</em></p>
</li>
</ol>
<h3 id="part-3-uart-communication">Part 3: UART Communication</h3>
<p>In this part of the lab, you'll be working with the group beside you to communicate between processor board.</p>
<ol>
<li>
<p>Add the following code to your program to create an unbuffered serial object for UART.</p>
<table>
<thead>
<tr>
<th></th>
<th>K64F</th>
<th>K66F</th>
</tr>
</thead>
<tbody>
<tr>
<td>UART TX</td>
<td>PTC17</td>
<td>PTC4</td>
</tr>
<tr>
<td>UART RX</td>
<td>PTC16</td>
<td>PTC3</td>
</tr>
</tbody>
</table>
<pre><code>static BufferedSerial serial_port(UART_TX, UART_RX, 9600); // replace with UART pins
</code></pre>
</li>
<li>
<p>Create a new thread then add a loop with the following to send some data.</p>
<pre><code>static char c = 'a';
static int x = 1;
serial_port.write(&amp;c, 1);
c += x;
if (c &gt;= 'z' || c &lt;= 'a')
    x *= -1;
ThisThread::sleep_for(1s);
</code></pre>
</li>
<li>
<p>Create a new thread or add the following code in the main <code>while</code> loop to read incoming UART data and print it to terminal.</p>
<pre><code>if (serial_port.read(&amp;c, 1)) {
    // Echo the input back to the terminal.
    ThisThread::sleep_for(100ms); // allow reading to finish
    printf("%c\n", c);
}
</code></pre>
</li>
<li>
<p>Connect the UART TX pin from one Freedom board to the UART RX pin on another board with an inline 1kΩ Resistor as well as a common ground. Once you run the program, the TX board will start sending a char per loop to the RX board and the received data will be displayed on the serial console. Do the same in reverse so you have two-ways communication between the boards.</p>
<blockquote>
<p><strong>Lab Question:</strong> Change your code to send multiple characters at a time (ie. "ABC123\n") through UART.</p>
</blockquote>
</li>
</ol>
<p>Once you've completed all the steps above (and ONLY when you are ready, as you'll only have one opportunity to demo), ask the lab professor or instructor to come over and demonstrate that you've completed the lab. You may be asked to explain some of the concepts you've learned in this lab.</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.16/apis/i-o-apis.html">AnalogIn</a></li>
<li>[1] <a href="https://learn.sparkfun.com/tutorials/i2c/all">https://learn.sparkfun.com/tutorials/i2c/all</a></li>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.16/apis/unbufferedserial.html">UnbufferedSerial</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
