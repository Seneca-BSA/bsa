<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Lab 6 - BSA Lab Manuals</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lab 6";
        var mkdocs_page_input_path = "sep600\\lab6.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> BSA Lab Manuals
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Lab Manuals</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../ses250/">SES250 Electromagnatics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../seh500/">SEH500 Microprocessors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../">SEP600 Embedded Systems</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../sea700/">SEA700 Robotics</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">BSA Lab Manuals</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Lab 6</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lab-6">Lab 6</h1>
<p><font size="5">
Seneca Polytechnic</br>
SEP600 Embedded Systems
</font></p>
<h2 id="introduction">Introduction</h2>
<p>Documentation of the Cortex-M4 instruction set, board user's guide, and the microcontroller reference manual can be found here:</p>
<h3 id="cortex-m4">Cortex M4</h3>
<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001">Arm Cortex-M4 Processor Technical Reference Manual Revision</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0403/latest/">ARMv7-M Architecture Reference Manual</a></li>
</ul>
<h3 id="frdm-k64f">FRDM-K64F</h3>
<ul>
<li><a href="../FRDMK64FUG.pdf">FRDM-K64F Freedom Module User’s Guide</a> (From <a href="https://www.nxp.com/webapp/Download?colCode=FRDMK64FUG">nxp.com</a>)</li>
<li><a href="../K64P144M120SF5RM.pdf">Kinetis K64 Reference Manual</a> (From <a href="https://www.nxp.com/webapp/Download?colCode=K64P144M120SF5RM">nxp.com</a>)</li>
<li><a href="https://os.mbed.com/platforms/FRDM-K64F/">FRDM-K64F mbed</a></li>
</ul>
<h3 id="frdm-k66f">FRDM-K66F</h3>
<ul>
<li><a href="../FRDMK66FUG.pdf">FRDM-K66F Freedom Module User’s Guide</a> (From <a href="https://www.nxp.com/webapp/Download?colCode=FRDMK66FUG">nxp.com</a>)</li>
<li><a href="../K66P144M180SF5RMV2.pdf">Kinetis K66 Reference Manual</a> (From <a href="https://www.nxp.com/webapp/Download?colCode=K66P144M180SF5RMV2">nxp.com</a>)</li>
<li><a href="https://os.mbed.com/platforms/FRDM-K66F/">FRDM-K66F mbed</a></li>
</ul>
<h2 id="materials">Materials</h2>
<ul>
<li>Safety glasses (PPE)</li>
<li>Breadboard</li>
<li>Jumper Wires</li>
</ul>
<h2 id="preparation">Preparation</h2>
<blockquote>
<h3 id="lab-preparation-question">Lab Preparation Question</h3>
<ol>
<li>Read over the lab and understand the procedures.</li>
</ol>
</blockquote>
<h2 id="procedures">Procedures</h2>
<p>In this lab, we'll explore the use of software filtering techniques to remove noise from a digital signal and then plot the data on a computer. We'll also explore the idea of multi-threading to handle the two tasks.</p>
<ol>
<li>
<p>Start the function generator to output a 1Vpp 1kHz Noise (or Triangular) wave with a 2V DC offset.</p>
</li>
<li>
<p>Connect the output of the function generator to an ADC (Analog input) pin on the K64F or K66F board.</p>
</li>
<li>
<p>Use the following code to read the signal from the ADC channel. Replace <code>PTXX</code> with the pin that you are using.
    <pre></p>
<pre><code>#include "mbed.h"

int main() {

    AnalogIn ain(PTXX); // Replace with your ADC pin

    float reading = 0; // for saving readings

    while (true) {
        reading = ain; // read ADC
        printf("Reading: %d\n", (int) (reading * 100)); // print as int
        // delay for 1ms for each reading
        ThisThread::sleep_for(1ms);
    }
}
</code></pre>
</pre>
</li>
<li>
<p>Your serial output should now be flooded with data output between 0 to 100.</p>
</li>
<li>
<p>Next, instead of printing data directly from within the <code>while</code> loop of the <code>main()</code> function, we'll put the printing into a thread so it won't interfere with the ADC reading and let the processor decide how to optimize the process.</p>
</li>
<li>
<p>Move the <code>printf</code> statement into a new function called <code>print_data()</code>. To pass variables into a thread, we'll make use of a pointer. Add the following code above the <code>main()</code> function.
    <pre></p>
<pre><code>void print_data(float *reading) {
    while (true) {
        printf("%d\n", (int) (*reading * 100));
        // delay for 1ms for between print
        ThisThread::sleep_for(1ms);
    }
}
</code></pre>
</pre>
</li>
<li>
<p>Next, we'll define a new thread called <code>print_data_thread</code> and use <code>print_data</code> as the callback function and pass the address of <code>reading</code> as the argument. Add the following above the <code>print_data()</code> function.
    <pre></p>
<pre><code>Thread print_data_thread;
</code></pre>
</pre>
</li>
<li>
<p>Add the following in the <code>main()</code> function to start the thread.
    <pre></p>
<pre><code>print_data_thread.start(callback(print_data, &amp;reading));
</code></pre>
</pre>
</li>
<li>
<p>Remember to remove the <code>printf</code> statement from your <code>main()</code> function.</p>
</li>
<li>
<p>Run your new code. It should be doing the same task as before but now it is running in multi-thread.</p>
</li>
<li>
<p>Let's read the data from the computer using Python and plot it out. Run the following Python script on your computer. Install <code>pyserial</code> using <code>pip install pyserial</code> and <code>matplotlib</code> using <code>pip install matplotlib</code> as required.
    <pre></p>
<pre><code>import serial
import matplotlib.pyplot as plt
import numpy as np
plt.ion()
fig=plt.figure()

x = list()
y = list()
i = 0

ser = serial.Serial('XXXX', 9600) # Replace XXXX with your serial port
ser.close()
ser.open()

while True:

    data = ser.readline()

    x.append(i)
    y.append(data.decode())

    plt.scatter(i, float(data.decode()))
    i += 1
    plt.show()
    plt.pause(0.000001)
</code></pre>
</pre>
</li>
<li>
<p>Run the Python code and it should open the specified serial and start plotting the data. As you can tell, it is not the most optimized plotting code. Feel free to improve the plotting.</p>
<p><img alt="Figure 6.1" src="../lab6-plot.png" /></p>
<p><strong><em>Figure 6.1</em></strong></p>
</li>
<li>
<p>From what you can tell, the data is a bit noisy. Your task is to add the simple IIR filter discussed in class to smooth out the data on the controller. This means adding a new variable called <code>alpha</code> and <code>old_reading</code> to save the reading for the next iteration.</p>
</li>
</ol>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.16/apis/thread.html">Thread</a></li>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.16/apis/mutex.html">Mutex</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
