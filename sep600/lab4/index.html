<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>Lab 4 : Serial UART and I2C Communication - BSA Lab Manuals</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../css/extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Lab 4 : Serial UART and I2C Communication";
        var mkdocs_page_input_path = "sep600/lab4.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> BSA Lab Manuals
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Lab Manuals</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../ses250/">SES250 Electromagnatics</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../seh500/">SEH500 Microprocessors</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../">SEP600 Embedded Systems</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">BSA Lab Manuals</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a> &raquo;</li>
      <li>Lab 4 : Serial UART and I2C Communication</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="lab-4-serial-uart-and-i2c-communication">Lab 4 : Serial UART and I2C Communication</h1>
<p><font size="5">
Seneca College</br>
SEP600 Embedded Systems
</font></p>
<h2 id="introduction">Introduction</h2>
<p>Documentation of the Cortex-M4 instruction set, board user's guide, and the microcontroller reference manual can be found here:</p>
<h3 id="cortex-m4">Cortex M4</h3>
<ul>
<li><a href="https://developer.arm.com/documentation/100166/0001">Arm Cortex-M4 Processor Technical Reference Manual Revision</a></li>
<li><a href="https://developer.arm.com/documentation/ddi0403/latest/">ARMv7-M Architecture Reference Manual</a></li>
</ul>
<h3 id="frdm-k64f">FRDM-K64F</h3>
<ul>
<li><a href="../FRDMK64FUG.pdf">FRDM-K64F Freedom Module User’s Guide</a> (From <a href="https://www.nxp.com/webapp/Download?colCode=FRDMK64FUG">nxp.com</a>)</li>
<li><a href="../K64P144M120SF5RM.pdf">Kinetis K64 Reference Manual</a> (From <a href="https://www.nxp.com/webapp/Download?colCode=K64P144M120SF5RM">nxp.com</a>)</li>
<li><a href="https://os.mbed.com/platforms/FRDM-K64F/">FRDM-K64F mbed</a></li>
</ul>
<h3 id="frdm-k66f">FRDM-K66F</h3>
<ul>
<li><a href="../FRDMK66FUG.pdf">FRDM-K66F Freedom Module User’s Guide</a> (From <a href="https://www.nxp.com/webapp/Download?colCode=FRDMK66FUG">nxp.com</a>)</li>
<li><a href="../K66P144M180SF5RMV2.pdf">Kinetis K66 Reference Manual</a> (From <a href="https://www.nxp.com/webapp/Download?colCode=K66P144M180SF5RMV2">nxp.com</a>)</li>
<li><a href="https://os.mbed.com/platforms/FRDM-K66F/">FRDM-K66F mbed</a></li>
</ul>
<h2 id="materials">Materials</h2>
<ul>
<li>Safety glasses (PPE)</li>
<li>Breadboard</li>
<li>Jumper Wires</li>
</ul>
<h2 id="preparation">Preparation</h2>
<blockquote>
<h3 id="lab-preparation-question">Lab Preparation Question</h3>
<ol>
<li>Read over the lab and understand the procedures.</li>
</ol>
</blockquote>
<h2 id="procedures">Procedures</h2>
<h3 id="part-1-onboard-i2c-accelerometer-and-magnetometer">Part 1: Onboard I2C Accelerometer and Magnetometer</h3>
<p>In Part 1, we'll take a look at how to setup getting reading from the onboard accelerometer and magnetometer.</p>
<div style="padding: 15px; border: 1px solid orange; background-color: orange; color: black;">
Check to see if the accelerometer is assembled on your board. NXP had a production change in 2023 and no longer assemble the FXOS8700CQ onto the Freedom board. If your board is missing the accelerometer chip (as shown in Figure 4.1 below), this part of the Lab will no work.
</div>

<p>The location U8 on the Freedom Board should be assembled with the FXOS8700CQ accelerometer chip.</p>
<p><img alt="Figure 4.1" src="../lab4-u8.png" /></p>
<p><em><strong>Figure 4.1</strong> Freedom Board with missing FXOS8700CQ accelerometer chip</em></p>
<ol>
<li>
<p>In order to use the FXOS8700CQ, you'll need to add the FXOS8700CQ library to your project. Start Mbed Studio than go to File &gt; Add Library to Active Program. When prompted, provide the following link <a href="https://os.mbed.com/teams/NXP/code/FXOS8700Q/">https://os.mbed.com/teams/NXP/code/FXOS8700Q/</a>.</p>
</li>
<li>
<p>The I2C pins used to connect to the accelerometer for the Freedom board are as follow:</p>
<table>
<thead>
<tr>
<th></th>
<th>K64F</th>
<th>K66F</th>
</tr>
</thead>
<tbody>
<tr>
<td>SDA</td>
<td>PTE25</td>
<td>PTD9</td>
</tr>
<tr>
<td>SCL</td>
<td>PTE24</td>
<td>PTD8</td>
</tr>
</tbody>
</table>
<p>Start your program with the following code to include the proper library and setup I2C.
<pre></p>
<pre><code>#include "mbed.h"
#include "FXOS8700Q.h"

I2C i2c(I2C_SDA, I2C_SCL); // replace with I2C pins
</code></pre>
</pre>
</li>
<li>
<p>Next, we'll create the accelerometer and magnetometer objects using the I2C object we created and the accelerometer's address. You can find the address in the header file.
    <pre></p>
<pre><code>FXOS8700QAccelerometer acc(i2c, FXOS8700CQ_SLAVE_ADDR1);
FXOS8700QMagnetometer mag(i2c, FXOS8700CQ_SLAVE_ADDR1);
</code></pre>
</pre>
<blockquote>
<p><strong>Lab Question:</strong> Look into the header file to find the slave address in HEX?</p>
</blockquote>
</li>
<li>
<p>Declare the variables for the sensor data within the <code>main</code> function then enable the sensor.
    <pre></p>
<pre><code>motion_data_units_t acc_data, mag_data;
float faX, faY, faZ, fmX, fmY, fmZ, tmp_float;

acc.enable();
mag.enable();
</code></pre>
</pre>
</li>
<li>
<p>Add a <code>while</code> loop to get accelerometer readings and print it out.
    <pre></p>
<pre><code>while (true) {
    acc.getAxis(acc_data);
    mag.getAxis(mag_data);
    printf("%3.3f %3.3f\r\n", acc_data.x, mag_data.x);
    ThisThread::sleep_for(500ms);
}
</code></pre>
</pre>
</li>
<li>
<p>Per <a href="https://github.com/ARMmbed/mbed-os/blob/master/platform/source/minimal-printf/README.md">Minimal printf and snprintf</a>, as of mbed OS 6, printf no longer print floating point by default to save memory. In order to enable printing of floating point value, enable it by creating a file called <code>mbed_app.json</code> in the root project folder and add the following code to it.
    <pre></p>
<pre><code>{
    "target_overrides": {
        "*": {
            "target.printf_lib": "std"
        }
    }
}
</code></pre>
</pre>
</li>
<li>
<p>Run your program and you should now see accelerometer and magnetometer readings. Refer to the FXOS8700Q libraries for other library functions and reading you can get.
    &gt; <strong>Lab Question:</strong> Try getting reading from different axis to figure out which direction is X, Y, and Z? When there are acceleration in an axis, you'll get acceleration reading on that axis (including gravity).</p>
</li>
</ol>
<h3 id="part-2-visualize-i2c-signal">Part 2: Visualize I2C Signal</h3>
<ol>
<li>
<p>Power off the Freedom board and connect the SDA pin to CH1 and SCL pin to CH2 of the oscilloscope.</p>
</li>
<li>
<p>With the I2C code running, adjust the oscilloscope to see the full I2C data frame. You might need to do this manually. If you cannot see the I2C signal, decrease the delay in each loop so data are send more often.
    &gt; <strong>Lab Question:</strong> Using the figure below as a reference, identify the start condition, the address, ACK, data, and stop condition of your I2C signal.</p>
<p><img alt="Figure 4.2" src="../lab4-i2c-frame.jpg" /></p>
<p><em><strong>Figure 4.2</strong> I2C data frame [1]</em></p>
</li>
</ol>
<h3 id="part-3-uart-communication">Part 3: UART Communication</h3>
<p>In this part of the lab, you'll be working with the group beside you to communicate between processor board.</p>
<ol>
<li>
<p>Add the following code to your program create a unbuffered serial object for UART.</p>
<table>
<thead>
<tr>
<th></th>
<th>K64F</th>
<th>K66F</th>
</tr>
</thead>
<tbody>
<tr>
<td>UART TX</td>
<td>PTC17</td>
<td>PTC4</td>
</tr>
<tr>
<td>UART RX</td>
<td>PTC16</td>
<td>PTC3</td>
</tr>
</tbody>
</table>
<pre>
<pre><code>static UnbufferedSerial serial_port(UART_TX, UART_RX); // replace with UART pins
</code></pre>
</pre>
</li>
<li>
<p>Add the following interrupt code to send incoming UART data to USB.
    <pre></p>
<pre><code>void on_rx_interrupt() {
    char c;

    if (serial_port.read(&amp;c, 1)) {
        // Echo the input back to the terminal.
        printf("%c", c);
    }
}
</code></pre>
</pre>
</li>
<li>
<p>Then add the following in the <code>main</code> function before the <code>while</code> loop.
    <pre></p>
<pre><code>// Set desired properties (9600-8-N-1).
serial_port.baud(9600);
serial_port.format(
    /* bits */ 8,
    /* parity */ SerialBase::None,
    /* stop bit */ 1
);

// Register a callback to process a Rx (receive) interrupt.
serial_port.attach(&amp;on_rx_interrupt, SerialBase::RxIrq);
</code></pre>
</pre>
</li>
<li>
<p>Add the following in your <code>while</code> loop to send some data.
    <pre></p>
<pre><code>static char c = 'a';
static int x = 1;
serial_port.write(&amp;c, 1);
if (c &gt;= 'z' || c &lt;= 'a')
    x *= -1;
c += x;
</code></pre>
</pre>
</li>
<li>
<p>Connect the UART TX pin from one board to the UART RX pin on another board. Once you run the program, the TX board will start sending a char per loop to the RX board and the received data will be display on the serial console.</p>
</li>
</ol>
<h2 id="reference">Reference</h2>
<ul>
<li>[1] <a href="https://learn.sparkfun.com/tutorials/i2c/all">https://learn.sparkfun.com/tutorials/i2c/all</a></li>
<li><a href="https://os.mbed.com/docs/mbed-os/v6.16/apis/unbufferedserial.html">UnbufferedSerial</a></li>
</ul>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
    
  </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
